{% minify %}

{#
  Initialize Global Env
#}

{% set cacheableEnv = craft.app.request.getParam('nocache') is same as(NULL)
  and not craft.app.request.isPost
  and not (doNotCache ?? false)
  and not craft.app.session.hasFlash('error')
  and not craft.app.session.hasFlash('notice')
%}
{% set cacheflags = cacheflags ?? 'entries|assets|globals|categories|users' %}
{% set cacheKeyPrefix = getenv('APP_ID') ~ ':v1' %}



{% set queries = {} %}
{% set themes = {} %}
{% set eagerload = {} %}

{% set assetManifest = source('_manifest.json')|json_decode %}
{% set styles = [
  devMode
  ? alias('@assetBaseUrl/build/style.' ~ assetManifest['style.css'] ~ '.css')
  : alias('@assetBaseUrl/build/style.purged.min.' ~ assetManifest['style.purged.min.css'] ~ '.css'),
] %}
{% set scripts = [
  alias('@assetBaseUrl/build/urgent.min.' ~ assetManifest['urgent.min.js'] ~ '.js'),
  alias('@assetBaseUrl/build/deferred.min.' ~ assetManifest['deferred.min.js'] ~ '.js'),
] %}



{%- block response_buffer -%}
  
  {% set htmlCacheKey = cacheKeyPrefix
    ~ '-css:' ~ assetManifest['style.purged.min.css']
    ~ '-js:' ~ assetManifest['urgent.min.js'] ~ assetManifest['deferred.min.js']
    ~ '-html:v1' %}
  
  {# Figure out if page should be cached #}
  {%- if cacheableEnv %}
    
    {# If a cacheKey is set, use that to globally cache the rendered page #}
    {% if cacheKey ?? false %}
      {% cacheflag flagged cacheflags globally using key (htmlCacheKey ~ ':' ~ cacheKey) for 1 month %}
        {{- block('response') -}}
      {% endcacheflag %}
      
    {% else %}
      
      {# No cacheKey set, cache the rendered page by url (not globally) #}
      {% cacheflag flagged cacheflags using key htmlCacheKey for 1 month %}
        {{- block('response') -}}
      {% endcacheflag %}
    {% endif %}
    
  {% else %}
    {%- block response %}{% endblock -%}
  {% endif %}
{%- endblock -%}

{% endminify -%}
